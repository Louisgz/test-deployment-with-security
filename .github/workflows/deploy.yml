name: Secure Deployment

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy-check-and-revert:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write # IMPORTANT : N√©cessaire pour pouvoir pusher le revert
      pull-requests: read
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√©cessaire pour avoir l'historique git pour le revert

      - name: Verify Conditions
        id: check_conditions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. V√©rification de l'utilisateur qui merge
          AUTHORIZED_USERS=("Louisgz" "DonGuych" "raph-asclepia")
          MERGER="${{ github.event.pull_request.merged_by.login }}"
          IS_AUTHORIZED_MERGER="false"

          for user in "${AUTHORIZED_USERS[@]}"; do
            if [ "$user" == "$MERGER" ]; then
              IS_AUTHORIZED_MERGER="true"
              break
            fi
          done

          echo "Merger: $MERGER"
          echo "Authorized Merger: $IS_AUTHORIZED_MERGER"

          # 2. V√©rification des Reviews (Approve OU Commentaire d'un Admin)
          echo "V√©rification des reviews..."

          # R√©cup√®re toutes les reviews en JSON
          REVIEWS_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews)

          # Logique de validation complexe en bash/jq
          # On cherche s'il existe AU MOINS UNE review qui est :
          # - Soit APPROVED (peu importe qui)
          # - Soit COMMENTED par un des admins (Louisgz, DonGuych, raph-asclepia)

          IS_VALIDATED="false"

          # V√©rif Approved
          APPROVED_COUNT=$(echo "$REVIEWS_JSON" | jq '[.[] | select(.state=="APPROVED")] | length')
          if [ "$APPROVED_COUNT" -gt "0" ]; then
            echo "‚úÖ Trouv√© $APPROVED_COUNT review(s) APPROVED."
            IS_VALIDATED="true"
          fi

          # V√©rif Commentaire Admin (si pas d√©j√† valid√©)
          if [ "$IS_VALIDATED" == "false" ]; then
            for admin in "${AUTHORIZED_USERS[@]}"; do
              COMMENT_COUNT=$(echo "$REVIEWS_JSON" | jq --arg user "$admin" '[.[] | select(.state=="COMMENTED" and .user.login==$user)] | length')
              if [ "$COMMENT_COUNT" -gt "0" ]; then
                echo "‚úÖ Trouv√© commentaire validant de l'admin $admin."
                IS_VALIDATED="true"
                break
              fi
            done
          fi

          if [ "$IS_VALIDATED" == "false" ]; then
             echo "‚ùå Aucune validation trouv√©e (Ni APPROVED, ni commentaire Admin)."
          fi

          # 3. D√©cision Finale
          if [ "$IS_AUTHORIZED_MERGER" == "false" ] || [ "$IS_VALIDATED" == "false" ]; then
            echo "‚ùå Conditions NON remplies."
            if [ "$IS_AUTHORIZED_MERGER" == "false" ]; then echo "- Utilisateur $MERGER non autoris√© √† merger."; fi
            if [ "$IS_VALIDATED" == "false" ]; then echo "- Pas de validation (Review Approve ou Commentaire Admin)."; fi
            
            echo "action=revert" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Conditions remplies (Merger autoris√© + Validation pr√©sente)."
            echo "action=deploy" >> $GITHUB_OUTPUT
          fi

      - name: Cancel Merge (Reset & Force Push)
        if: steps.check_conditions.outputs.action == 'revert'
        run: |
          echo "‚õî SECURIT√â : Annulation radicale du merge (Hard Reset)..."

          # Configuration Git pour le bot
          git config --global user.name "Security Bot"
          git config --global user.email "security-bot@noreply.github.com"

          # On revient 1 commit en arri√®re (avant le merge)
          # Cela supprime purement et simplement le commit de merge de l'historique local
          git reset --hard HEAD~1

          echo "Force Push vers main pour √©craser l'historique..."
          # Le force push est obligatoire ici pour r√©√©crire l'historique distant
          git push origin main --force

          echo "‚úÖ Merge annul√© et effac√© de l'historique. La branche main est propre."
          echo "üëâ Vous pouvez maintenant corriger votre PR et r√©essayer."
          exit 1 # On signale l'√©chec pour l'interface GitHub

      - name: Deploy
        if: steps.check_conditions.outputs.action == 'deploy'
        run: |
          echo "üöÄ Validation OK. D√©marrage du d√©ploiement..."
          # Vos commandes de d√©ploiement ici
          echo "d√©ploy√©"
