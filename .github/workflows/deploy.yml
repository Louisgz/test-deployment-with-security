name: Secure Deployment

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy-check-and-revert:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write # IMPORTANT : N√©cessaire pour pouvoir pusher le revert
      pull-requests: read
      actions: write # Permet de g√©rer les runs, parfois n√©cessaire, mais 'workflows' n'existe pas. On essaie sans ou avec actions.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√©cessaire pour avoir l'historique git pour le revert

      - name: Verify Conditions
        id: check_conditions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. V√©rification de l'utilisateur
          AUTHORIZED_USERS=("Louisgz" "DonGuych" "raph-asclepia")
          MERGER="${{ github.event.pull_request.merged_by.login }}"
          IS_AUTHORIZED="false"

          for user in "${AUTHORIZED_USERS[@]}"; do
            if [ "$user" == "$MERGER" ]; then
              IS_AUTHORIZED="true"
              break
            fi
          done

          echo "Merger: $MERGER"
          echo "Authorized: $IS_AUTHORIZED"

          # 2. V√©rification des Reviews
          REVIEW_COUNT=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            --jq '[.[] | select(.state=="APPROVED")] | length')

          echo "Approved Reviews: $REVIEW_COUNT"

          # 3. D√©cision
          if [ "$IS_AUTHORIZED" == "false" ] || [ "$REVIEW_COUNT" == "0" ]; then
            echo "‚ùå Conditions NON remplies."
            if [ "$IS_AUTHORIZED" == "false" ]; then echo "- Utilisateur $MERGER non autoris√©."; fi
            if [ "$REVIEW_COUNT" == "0" ]; then echo "- Aucune approbation (review)."; fi
            
            echo "action=revert" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Conditions remplies."
            echo "action=deploy" >> $GITHUB_OUTPUT
          fi

      - name: Cancel Merge (Reset & Force Push)
        if: steps.check_conditions.outputs.action == 'revert'
        run: |
          echo "‚õî SECURIT√â : Annulation radicale du merge (Hard Reset)..."

          # Configuration Git pour le bot
          git config --global user.name "Security Bot"
          git config --global user.email "security-bot@noreply.github.com"

          # On revient 1 commit en arri√®re (avant le merge)
          # Cela supprime purement et simplement le commit de merge de l'historique local
          git reset --hard HEAD~1

          echo "Force Push vers main pour √©craser l'historique..."
          # Le force push est obligatoire ici pour r√©√©crire l'historique distant
          git push origin main --force

          echo "‚úÖ Merge annul√© et effac√© de l'historique. La branche main est propre."
          echo "üëâ Vous pouvez maintenant corriger votre PR et r√©essayer."
          exit 1 # On signale l'√©chec pour l'interface GitHub

      - name: Deploy
        if: steps.check_conditions.outputs.action == 'deploy'
        run: |
          echo "üöÄ Validation OK. D√©marrage du d√©ploiement..."
          # Vos commandes de d√©ploiement ici
          echo "d√©ploy√©"
