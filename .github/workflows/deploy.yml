name: Secure Deployment

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy-check-and-revert:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write # IMPORTANT : N√©cessaire pour pouvoir pusher le revert
      pull-requests: read
      actions: write # Permet de g√©rer les runs, parfois n√©cessaire, mais 'workflows' n'existe pas. On essaie sans ou avec actions.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√©cessaire pour avoir l'historique git pour le revert

      - name: Verify Conditions
        id: check_conditions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. V√©rification de l'utilisateur
          AUTHORIZED_USERS=("Louisgz" "DonGuych" "raph-asclepia")
          MERGER="${{ github.event.pull_request.merged_by.login }}"
          IS_AUTHORIZED="false"

          for user in "${AUTHORIZED_USERS[@]}"; do
            if [ "$user" == "$MERGER" ]; then
              IS_AUTHORIZED="true"
              break
            fi
          done

          echo "Merger: $MERGER"
          echo "Authorized: $IS_AUTHORIZED"

          # 2. V√©rification des Reviews
          REVIEW_COUNT=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            --jq '[.[] | select(.state=="APPROVED")] | length')

          echo "Approved Reviews: $REVIEW_COUNT"

          # 3. D√©cision
          if [ "$IS_AUTHORIZED" == "false" ] || [ "$REVIEW_COUNT" == "0" ]; then
            echo "‚ùå Conditions NON remplies."
            if [ "$IS_AUTHORIZED" == "false" ]; then echo "- Utilisateur $MERGER non autoris√©."; fi
            if [ "$REVIEW_COUNT" == "0" ]; then echo "- Aucune approbation (review)."; fi
            
            echo "action=revert" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Conditions remplies."
            echo "action=deploy" >> $GITHUB_OUTPUT
          fi

      - name: Revert Merge (Si non autoris√©)
        if: steps.check_conditions.outputs.action == 'revert'
        run: |
          echo "‚õî SECURIT√â : Annulation automatique du merge (Revert)..."

          # Configuration Git pour le bot
          git config --global user.name "Security Bot"
          git config --global user.email "security-bot@noreply.github.com"

          # Le merge commit est HEAD. On le revert.
          # -m 1 indique qu'on garde le parent de la branche main (le c√¥t√© "main" du merge)
          git revert -m 1 HEAD --no-edit

          echo "Push du revert vers main..."
          git push origin main

          echo "‚úÖ Revert effectu√© avec succ√®s. Le code non autoris√© a √©t√© retir√©."
          exit 1 # On fait √©chouer le job pour marquer l'incident en rouge dans l'interface

      - name: Deploy
        if: steps.check_conditions.outputs.action == 'deploy'
        run: |
          echo "üöÄ Validation OK. D√©marrage du d√©ploiement..."
          # Vos commandes de d√©ploiement ici
          echo "d√©ploy√©"
