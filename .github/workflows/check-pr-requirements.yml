name: Check PR Requirements

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Review Approvals
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîé V√©rification des approbations pour la PR #${{ github.event.pull_request.number }}..."

          # R√©cup√®re le nombre de reviews avec l'√©tat 'APPROVED'
          COUNT=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            --jq '[.[] | select(.state=="APPROVED")] | length')

          echo "Nombre d'approbations trouv√©es : $COUNT"

          if [ "$COUNT" = "0" ]; then
            echo "‚ùå ECHEC : Cette Pull Request n'a pas encore √©t√© approuv√©e par un reviewer."
            echo "‚ö†Ô∏è  Merci d'attendre une validation avant de merger."
            exit 1
          else
            echo "‚úÖ SUCC√àS : La PR a √©t√© approuv√©e ($COUNT approbation(s))."
            exit 0
          fi
