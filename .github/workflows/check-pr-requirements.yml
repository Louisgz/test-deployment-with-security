name: Check PR Requirements

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Review Approvals
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîé V√©rification des approbations pour la PR #${{ github.event.pull_request.number }}..."

          # Liste des admins
          AUTHORIZED_USERS=("Louisgz" "DonGuych" "raph-asclepia")

          # R√©cup√®re toutes les reviews
          REVIEWS_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews)

          IS_VALIDATED="false"

          # 1. V√©rif Approved
          APPROVED_COUNT=$(echo "$REVIEWS_JSON" | jq '[.[] | select(.state=="APPROVED")] | length')
          if [ "$APPROVED_COUNT" -gt "0" ]; then
            echo "‚úÖ Trouv√© $APPROVED_COUNT review(s) APPROVED."
            IS_VALIDATED="true"
          fi

          # 2. V√©rif Commentaire Admin
          if [ "$IS_VALIDATED" == "false" ]; then
            for admin in "${AUTHORIZED_USERS[@]}"; do
              COMMENT_COUNT=$(echo "$REVIEWS_JSON" | jq --arg user "$admin" '[.[] | select(.state=="COMMENTED" and .user.login==$user)] | length')
              if [ "$COMMENT_COUNT" -gt "0" ]; then
                echo "‚úÖ Trouv√© commentaire validant de l'admin $admin."
                IS_VALIDATED="true"
                break
              fi
            done
          fi

          if [ "$IS_VALIDATED" == "true" ]; then
            echo "‚úÖ SUCC√àS : La PR est consid√©r√©e comme valid√©e."
            exit 0
          else
            echo "‚ùå ECHEC : La PR n'est pas valid√©e."
            echo "Conditions requises :"
            echo "  - Soit une review 'APPROVED' (par n'importe qui)"
            echo "  - Soit un commentaire ('COMMENTED') de : ${AUTHORIZED_USERS[*]}"
            exit 1
          fi
